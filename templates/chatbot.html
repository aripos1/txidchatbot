<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ë¸”ë¡ì²´ì¸ ì±—ë´‡ - Multi-Chain Transaction Lookup</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            height: 100dvh; /* ë™ì  viewport ë†’ì´ (ëª¨ë°”ì¼ ì£¼ì†Œì°½ ê³ ë ¤) */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow: hidden; /* ìŠ¤í¬ë¡¤ ë°©ì§€ */
            position: fixed; /* ëª¨ë°”ì¼ì—ì„œ í™”ë©´ ê³ ì • */
            width: 100%;
            top: 0;
            left: 0;
            touch-action: pan-y; /* ìˆ˜ì§ ìŠ¤í¬ë¡¤ë§Œ í—ˆìš© */
        }

        .chat-container {
            width: 100%;
            max-width: 900px;
            height: 90vh;
            height: 90dvh; /* ë™ì  viewport ë†’ì´ */
            max-height: calc(100vh - 40px);
            max-height: calc(100dvh - 40px);
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .clear-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .clear-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 30px;
            background: #f8f9fa;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch; /* iOS ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ */
            overscroll-behavior: contain; /* ìŠ¤í¬ë¡¤ ì²´ì´ë‹ ë°©ì§€ */
        }

        .message {
            margin-bottom: 24px;
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.3s;
        }

        .message:last-child {
            margin-bottom: 0;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            align-items: flex-end;
        }

        .message.assistant {
            align-items: flex-start;
        }

        .message-bubble {
            max-width: 75%;
            width: fit-content;
            padding: 18px 22px;
            border-radius: 18px;
            word-wrap: break-word;
            word-break: break-word;
            line-height: 1.7;
            font-size: 15px;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
            font-weight: 500;
        }

        .message.assistant .message-bubble {
            background: white;
            color: #2c3e50;
            border: 1px solid #e0e0e0;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        /* ë©”ì‹œì§€ ë‚´ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ ê°œì„  */
        .message.assistant .message-bubble p {
            margin-bottom: 12px;
        }

        .message.assistant .message-bubble p:last-child {
            margin-bottom: 0;
        }

        .message.assistant .message-bubble ul,
        .message.assistant .message-bubble ol {
            margin: 12px 0;
            padding-left: 24px;
        }

        .message.assistant .message-bubble li {
            margin-bottom: 6px;
        }

        .message.assistant .message-bubble strong {
            color: #1a252f;
            font-weight: 600;
        }

        .message.assistant .message-bubble a {
            color: #667eea;
            text-decoration: none;
            border-bottom: 1px solid rgba(102, 126, 234, 0.3);
            transition: all 0.2s;
        }

        .message.assistant .message-bubble a:hover {
            color: #764ba2;
            border-bottom-color: #764ba2;
        }

        .message.assistant .message-bubble code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #e83e8c;
        }

        .message.assistant .message-bubble pre {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 12px 0;
            border: 1px solid #e0e0e0;
        }

        .message.assistant .message-bubble pre code {
            background: none;
            padding: 0;
            color: #2c3e50;
        }

        /* ìŠ¤íŠ¸ë¦¬ë° ì»¤ì„œ ì• ë‹ˆë©”ì´ì…˜ */
        .streaming-cursor {
            display: inline-block;
            animation: blink 1s step-end infinite;
            color: #667eea;
            font-weight: bold;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        /* ë…¸ë“œ ì§„í–‰ ìƒíƒœ í‘œì‹œ */
        .node-status {
            color: #888;
            font-style: italic;
            font-size: 14px;
        }

        /* ìƒê°í•˜ëŠ” ê³¼ì • ì˜ì—­ */
        .thinking-process {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 8px 12px;
            margin-top: 10px;
            margin-bottom: 0;
            font-size: 12px;
            color: #495057;
            transition: all 0.3s ease;
            width: 100%;
            clear: both;
            align-self: flex-start;
        }

        .thinking-process.collapsed {
            max-height: 32px;
            overflow: hidden;
        }

        .thinking-process.expanded {
            max-height: 350px;
            overflow-y: auto;
        }

        .thinking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            padding: 2px 0;
        }

        .thinking-title {
            font-weight: 500;
            color: #6c757d;
            font-size: 11px;
        }

        .thinking-toggle {
            color: #adb5bd;
            font-size: 10px;
            transition: transform 0.3s;
        }

        .thinking-process.expanded .thinking-toggle {
            transform: rotate(180deg);
        }

        .thinking-content {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e9ecef;
        }

        .thinking-step {
            margin-bottom: 6px;
            padding: 6px 10px;
            background: white;
            border-radius: 6px;
            border-left: 2px solid #dee2e6;
            transition: all 0.2s ease;
        }

        .thinking-step:hover {
            border-left-color: #667eea;
            background: #f8f9ff;
        }

        .thinking-step-title {
            font-weight: 600;
            color: #495057;
            margin-bottom: 3px;
            font-size: 11px;
        }

        .thinking-step-content {
            color: #6c757d;
            font-size: 11px;
            line-height: 1.4;
        }

        .chat-input-container {
            padding: 20px 30px;
            background: white;
            border-top: 1px solid #e0e0e0;
            flex-shrink: 0;
        }

        .chat-input-form {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }

        .chat-input:focus {
            border-color: #667eea;
        }

        .send-btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading {
            display: flex;
            gap: 5px;
            padding: 15px 20px;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #999;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .loading-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 60px 20px;
        }

        .empty-state h2 {
            margin-bottom: 10px;
            color: #666;
        }

        .empty-state p {
            font-size: 14px;
        }

        /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ë§ */
        .chat-messages::-webkit-scrollbar {
            width: 10px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 10px;
            border: 2px solid #f1f1f1;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #999;
        }

        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            body {
                padding: 0;
                padding-bottom: env(safe-area-inset-bottom, 0px);
                height: 100vh;
                height: 100dvh;
            }

            .chat-container {
                height: 100vh;
                height: 100dvh;
                max-height: 100vh;
                max-height: 100dvh;
                border-radius: 0;
                width: 100%;
                padding-bottom: env(safe-area-inset-bottom, 0px);
            }

            .message-bubble {
                max-width: 85%;
                padding: 14px 18px;
                font-size: 14px;
            }

            .chat-messages {
                padding: 20px;
                padding-bottom: 100px; /* ì…ë ¥ì°½ ê³µê°„ í™•ë³´ */
                margin-bottom: env(safe-area-inset-bottom, 0px);
            }

            .chat-header {
                padding: 16px 20px;
                padding-top: max(16px, calc(16px + env(safe-area-inset-top, 0px)));
            }

            .chat-header h1 {
                font-size: 20px;
            }

            .chat-input-container {
                padding: 12px 16px;
                padding-bottom: max(12px, calc(12px + env(safe-area-inset-bottom, 0px)));
                position: sticky;
                bottom: 0;
                background: white;
                z-index: 100;
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
                margin-top: auto;
            }

            .chat-input {
                font-size: 16px; /* iOS ì¤Œ ë°©ì§€ */
                padding: 12px 18px;
            }

            .send-btn {
                padding: 12px 24px;
                font-size: 15px;
            }
        }

        /* ëª¨ë°”ì¼ ì£¼ì†Œì°½ ë³€í™” ëŒ€ì‘ */
        @media (max-height: 500px) {
            .chat-container {
                height: 100vh;
                height: 100dvh;
            }
        }

        /* iOS Safari ë° ëª¨ë°”ì¼ ë¸Œë¼ìš°ì € í•˜ë‹¨ UI ëŒ€ì‘ */
        @supports (padding: max(0px)) {
            @media (max-width: 768px) {
                html {
                    padding-bottom: env(safe-area-inset-bottom, 0px);
                }

                .chat-input-container {
                    padding-bottom: max(12px, calc(12px + env(safe-area-inset-bottom, 20px)));
                    bottom: env(safe-area-inset-bottom, 0px);
                }

                .chat-messages {
                    padding-bottom: calc(100px + env(safe-area-inset-bottom, 0px));
                }
            }
        }

        /* ì•ˆì „ ì˜ì—­ì´ ì—†ëŠ” ë¸Œë¼ìš°ì €ë¥¼ ìœ„í•œ ê¸°ë³¸ ì—¬ë°± */
        @media (max-width: 768px) {
            .chat-input-container {
                padding-bottom: calc(12px + 20px); /* ê¸°ë³¸ 20px ì—¬ë°± ì¶”ê°€ */
            }
            
            .chat-messages {
                padding-bottom: 120px; /* ì…ë ¥ì°½ + ì—¬ë°± */
            }
        }

        /* ì„ íƒëœ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        ::selection {
            background: rgba(102, 126, 234, 0.3);
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h1>ğŸ¤– ë¸”ë¡ì²´ì¸ ì±—ë´‡</h1>
            <button class="clear-btn" onclick="clearChat()">ëŒ€í™” ê¸°ë¡ ì‚­ì œ</button>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="empty-state">
                <h2>ì•ˆë…•í•˜ì„¸ìš”! ğŸ‘‹</h2>
                <p>ë¸”ë¡ì²´ì¸ê³¼ ë¹—ì¸ ê±°ë˜ì†Œì— ê´€ë ¨ëœ ì§ˆë¬¸ì„ í•´ì£¼ì„¸ìš”.</p>
            </div>
        </div>
        
        <div class="chat-input-container">
            <form class="chat-input-form" onsubmit="sendMessage(event)">
                <input 
                    type="text" 
                    class="chat-input" 
                    id="messageInput" 
                    placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                    autocomplete="off"
                >
                <button type="submit" class="send-btn" id="sendBtn">ì „ì†¡</button>
            </form>
        </div>
    </div>

    <script>
        // ë…¸ë“œ í‘œì‹œ ì´ë¦„ ë§¤í•‘ (ê³µí†µ)
        const NODE_DISPLAY_NAMES = {
            "router": "ğŸ”€ ë¼ìš°íŒ… ì¤‘...",
            "simple_chat_specialist": "ğŸ’¬ ì‘ë‹µ ìƒì„± ì¤‘...",
            "faq_specialist": "ğŸ“š FAQ ê²€ìƒ‰ ì¤‘...",
            "transaction_specialist": "ğŸ” íŠ¸ëœì­ì…˜ ì¡°íšŒ ì¤‘...",
            "hybrid_specialist": "ğŸ”„ í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ ì¤‘...",
            "planner": "ğŸ“‹ ê²€ìƒ‰ ê³„íš ì¤‘...",
            "researcher": "ğŸ” ì›¹ ê²€ìƒ‰ ì¤‘...",
            "grader": "ğŸ“Š ê²°ê³¼ í‰ê°€ ì¤‘...",
            "writer": "âœï¸ ì‘ë‹µ ì‘ì„± ì¤‘...",
            "intent_clarifier": "ğŸ¤” ì˜ë„ í™•ì¸ ì¤‘...",
            "save_response": "ğŸ’¾ ì €ì¥ ì¤‘..."
        };

        // ë…¸ë“œ ì´ë¦„ì„ "ìƒê°í•˜ëŠ” ê³¼ì •" ì œëª©ìœ¼ë¡œ ë³€í™˜
        function getNodeStepTitle(nodeName, displayName) {
            const nodeTitleMap = {
                'router': 'ğŸ”€ ë¼ìš°íŒ…',
                'faq_specialist': 'ğŸ“š FAQ ê²€ìƒ‰',
                'transaction_specialist': 'ğŸ” íŠ¸ëœì­ì…˜ ì¡°íšŒ',
                'hybrid_specialist': 'ğŸ”„ í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰',
                'planner': 'ğŸ“‹ ê²€ìƒ‰ ê³„íš ìˆ˜ë¦½',
                'researcher': 'ğŸ” ì›¹ ê²€ìƒ‰',
                'grader': 'ğŸ“Š ê²°ê³¼ í‰ê°€',
                'writer': 'âœï¸ ì‘ë‹µ ì‘ì„±',
                'intent_clarifier': 'ğŸ¤” ì˜ë„ í™•ì¸',
                'save_response': 'ğŸ’¾ ì €ì¥'
            };
            
            return nodeTitleMap[nodeName] || displayName || null;
        }

        // "ìƒê°í•˜ëŠ” ê³¼ì •" ì œëª©ì—ì„œ ë…¸ë“œ ì´ë¦„ ì¶”ì¶œ
        function getNodeNameFromStep(stepTitle) {
            const titleToNodeMap = {
                'ğŸ”€ ë¼ìš°íŒ…': 'router',
                'ğŸ“š FAQ ê²€ìƒ‰': 'faq_specialist',
                'ğŸ” íŠ¸ëœì­ì…˜ ì¡°íšŒ': 'transaction_specialist',
                'ğŸ”„ í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰': 'hybrid_specialist',
                'ğŸ“‹ ê²€ìƒ‰ ê³„íš ìˆ˜ë¦½': 'planner',
                'ğŸ” ì›¹ ê²€ìƒ‰': 'researcher',
                'ğŸ“Š ê²°ê³¼ í‰ê°€': 'grader',
                'âœï¸ ì‘ë‹µ ì‘ì„±': 'writer',
                'ğŸ¤” ì˜ë„ í™•ì¸': 'intent_clarifier',
                'ğŸ’¾ ì €ì¥': 'save_response'
            };
            
            return titleToNodeMap[stepTitle] || null;
        }




        // JSONì„ ì‚¬ìš©ì ì¹œí™”ì ì¸ "ìƒê°í•˜ëŠ” ê³¼ì •"ìœ¼ë¡œ ë³€í™˜
        function parseThinkingProcess(jsonText) {
            try {
                const json = JSON.parse(jsonText);
                const steps = [];
                
                // Planner ë…¸ë“œ ì •ë³´
                if (json.search_queries || json.research_plan || json.priority) {
                    steps.push({
                        title: 'ğŸ“‹ ê²€ìƒ‰ ê³„íš ìˆ˜ë¦½',
                        content: json.research_plan || 'ê²€ìƒ‰ ê³„íšì„ ìˆ˜ë¦½í•˜ê³  ìˆìŠµë‹ˆë‹¤.',
                        queries: json.search_queries || []
                    });
                }
                
                // Grader ë…¸ë“œ ì •ë³´
                if (json.score !== undefined || json.is_sufficient !== undefined || json.feedback) {
                    const score = json.score || 0;
                    const isSufficient = json.is_sufficient || false;
                    const feedback = json.feedback || '';
                    
                    steps.push({
                        title: `ğŸ“Š ê²°ê³¼ í‰ê°€ (ì ìˆ˜: ${(score * 100).toFixed(0)}%)`,
                        content: feedback || (isSufficient ? 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì¶©ë¶„í•©ë‹ˆë‹¤.' : 'ì¶”ê°€ ê²€ìƒ‰ì´ í•„ìš”í•©ë‹ˆë‹¤.'),
                        score: score,
                        isSufficient: isSufficient
                    });
                }
                
                return steps;
            } catch (e) {
                return [];
            }
        }

        // "ìƒê°í•˜ëŠ” ê³¼ì •" UI ìƒì„± (ê°„ì†Œí™”)
        function createThinkingProcessUI(steps) {
            // ë‚´ìš©ì´ ìˆëŠ” ë‹¨ê³„ë§Œ í•„í„°ë§
            const stepsWithContent = steps.filter(step => step.content && step.content.trim());
            
            if (stepsWithContent.length === 0) return null;
            
            const container = document.createElement('div');
            container.className = 'thinking-process collapsed';
            
            const header = document.createElement('div');
            header.className = 'thinking-header';
            header.innerHTML = `
                <div class="thinking-title">
                    <span>ğŸ¤” ìƒê°í•˜ëŠ” ê³¼ì • (${stepsWithContent.length}ë‹¨ê³„)</span>
                </div>
                <span class="thinking-toggle">â–¼</span>
            `;
            
            const content = document.createElement('div');
            content.className = 'thinking-content';
            
            stepsWithContent.forEach(step => {
                const stepDiv = document.createElement('div');
                stepDiv.className = 'thinking-step';
                
                let stepHTML = `<div class="thinking-step-title">${step.title}</div>`;
                if (step.content) {
                    stepHTML += `<div class="thinking-step-content">${step.content}</div>`;
                }
                
                stepDiv.innerHTML = stepHTML;
                content.appendChild(stepDiv);
            });
            
            container.appendChild(header);
            container.appendChild(content);
            
            // í† ê¸€ ê¸°ëŠ¥
            header.addEventListener('click', () => {
                if (container.classList.contains('collapsed')) {
                    container.classList.remove('collapsed');
                    container.classList.add('expanded');
                    header.querySelector('.thinking-toggle').textContent = 'â–²';
                } else {
                    container.classList.remove('expanded');
                    container.classList.add('collapsed');
                    header.querySelector('.thinking-toggle').textContent = 'â–¼';
                }
            });
            
            return container;
        }

        // ì„¸ì…˜ ID ìƒì„± (ë¸Œë¼ìš°ì € ì„¸ì…˜ë‹¹ ê³ ìœ )
        let sessionId = sessionStorage.getItem('chatSessionId') || generateSessionId();
        if (!sessionStorage.getItem('chatSessionId')) {
            sessionStorage.setItem('chatSessionId', sessionId);
        }

        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ëŒ€í™” ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        window.addEventListener('DOMContentLoaded', async () => {
            await loadChatHistory();
        });

        async function loadChatHistory() {
            try {
                const response = await fetch(`/api/chat/history/${sessionId}`);
                const data = await response.json();
                
                if (data.history && data.history.length > 0) {
                    const messagesContainer = document.getElementById('chatMessages');
                    messagesContainer.innerHTML = '';
                    
                    data.history.forEach(msg => {
                        addMessageToChat(msg.role, msg.content, false);
                    });
                }
            } catch (error) {
                console.error('ëŒ€í™” ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
            }
        }

        // ìŠ¤íŠ¸ë¦¬ë° ëª¨ë“œ ì„¤ì • (true: ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë°, false: ê¸°ì¡´ ë°©ì‹)
        const USE_STREAMING = true;
        let currentAbortController = null;

        async function sendMessage(event) {
            event.preventDefault();
            
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // ì´ì „ ìš”ì²­ ì·¨ì†Œ
            if (currentAbortController) {
                currentAbortController.abort();
            }
            currentAbortController = new AbortController();
            
            // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
            addMessageToChat('user', message);
            input.value = '';
            
            // ì…ë ¥ ë¹„í™œì„±í™”
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            
            if (USE_STREAMING) {
                await sendMessageStreaming(message, sendBtn);
            } else {
                await sendMessageNormal(message, sendBtn);
            }
            
            // ì…ë ¥ í•„ë“œë¡œ í¬ì»¤ìŠ¤
            input.focus();
        }

        async function sendMessageStreaming(message, sendBtn) {
            // ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µìš© ë©”ì‹œì§€ ë²„ë¸” ìƒì„±
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.innerHTML = '<span class="streaming-cursor">â–Š</span>';
            
            messageDiv.appendChild(bubble);
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // "ìƒê°í•˜ëŠ” ê³¼ì •" ì˜ì—­ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€)
            let thinkingProcessUI = null;
            let thinkingSteps = [];
            let shouldShowThinkingProcess = false;  // ë‹µë³€ ì™„ë£Œ í›„ í‘œì‹œí• ì§€ ì—¬ë¶€
            let currentResponseNode = null;  // í˜„ì¬ ì‘ë‹µì„ ìƒì„±í•˜ëŠ” ë…¸ë“œ ì¶”ì 
            let nodeSearchInfo = {};  // ë…¸ë“œë³„ ê²€ìƒ‰ ì •ë³´ ì €ì¥
            
            let fullContent = '';
            let hasReceivedToken = false;  // í† í° ìˆ˜ì‹  ì—¬ë¶€ ì¶”ì 
            let jsonBlocks = [];  // ìˆ˜ì§‘ëœ JSON ë¸”ë¡
            let nodeHistory = [];  // ë…¸ë“œ ì‹¤í–‰ ì´ë ¥
            
            // "ìƒê°í•˜ëŠ” ê³¼ì •" ê´€ë ¨ ê³µí†µ í•¨ìˆ˜ë“¤ (sendMessageStreaming ë‚´ë¶€ì—ì„œ ì •ì˜)
            
            // ê²€ìƒ‰ ì •ë³´ë¥¼ "ìƒê°í•˜ëŠ” ê³¼ì •" ì½˜í…ì¸ ë¡œ ë³€í™˜ (ê°„ì†Œí™”)
            function createThinkingStepContent(nodeName, nodeDisplay, searchInfo) {
                const queries = searchInfo.queries || [];
                const dbResults = searchInfo.db_results || [];
                const webResults = searchInfo.web_results || [];
                
                // ê²€ìƒ‰ ì •ë³´ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ë©”ì‹œì§€ë„ í‘œì‹œí•˜ì§€ ì•ŠìŒ
                if (queries.length === 0 && dbResults.length === 0 && webResults.length === 0) {
                    return null; // ë‚´ìš©ì´ ì—†ìœ¼ë©´ null ë°˜í™˜
                }
                
                let contentParts = [];
                
                // ê²€ìƒ‰ ì¿¼ë¦¬ê°€ ìˆìœ¼ë©´ ê°„ë‹¨íˆ í‘œì‹œ (ìµœëŒ€ 2ê°œ)
                if (queries.length > 0) {
                    const displayQueries = queries.slice(0, 2);
                    const queryText = displayQueries.join(', ');
                    const extraCount = queries.length - 2;
                    contentParts.push(`ê²€ìƒ‰: ${queryText}${extraCount > 0 ? ` ì™¸ ${extraCount}ê°œ` : ''}`);
                }
                
                // ê²€ìƒ‰ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ê°„ë‹¨íˆ ìš”ì•½
                const totalResults = dbResults.length + webResults.length;
                if (totalResults > 0) {
                    const resultTypes = [];
                    if (dbResults.length > 0) resultTypes.push(`FAQ ${dbResults.length}ê°œ`);
                    if (webResults.length > 0) resultTypes.push(`ì›¹ ${webResults.length}ê°œ`);
                    contentParts.push(`ê²°ê³¼: ${resultTypes.join(', ')}`);
                }
                
                return contentParts.length > 0 ? contentParts.join(' â€¢ ') : null;
            }

            // "ìƒê°í•˜ëŠ” ê³¼ì •" ë‹¨ê³„ ì¶”ê°€ ë˜ëŠ” ì—…ë°ì´íŠ¸
            function addOrUpdateThinkingStep(nodeName, nodeDisplay, searchInfo) {
                // simple_chat_specialistì™€ transaction_specialistëŠ” ì œì™¸
                if (!nodeName || nodeName === 'simple_chat_specialist' || nodeName === 'transaction_specialist') {
                    return -1;
                }
                
                const stepTitle = getNodeStepTitle(nodeName, '');
                if (!stepTitle) {
                    return -1;
                }
                
                // ê¸°ì¡´ ë‹¨ê³„ ì°¾ê¸°
                let stepIndex = thinkingSteps.findIndex(step => {
                    const stepNodeName = getNodeNameFromStep(step.title);
                    return stepNodeName === nodeName;
                });
                
                // ë‹¨ê³„ê°€ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
                if (stepIndex === -1) {
                    // ë…¸ë“œ ì´ë ¥ì— ì¶”ê°€
                    if (!nodeHistory.some(n => n.name === nodeName)) {
                        nodeHistory.push({
                            name: nodeName,
                            display: nodeDisplay || NODE_DISPLAY_NAMES[nodeName] || nodeName
                        });
                    }
                    
                    // ìƒˆ ë‹¨ê³„ ì¶”ê°€
                    thinkingSteps.push({
                        title: stepTitle,
                        content: '',
                        queries: [],
                        searchInfo: {}
                    });
                    stepIndex = thinkingSteps.length - 1;
                }
                
                // ê²€ìƒ‰ ì •ë³´ë¡œ ì½˜í…ì¸  ì—…ë°ì´íŠ¸
                const content = createThinkingStepContent(nodeName, '', searchInfo);
                
                // ë‚´ìš©ì´ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸, ì—†ìœ¼ë©´ nullë¡œ ì„¤ì • (ë‚˜ì¤‘ì— í•„í„°ë§ë¨)
                thinkingSteps[stepIndex].content = content;
                thinkingSteps[stepIndex].queries = searchInfo.queries || [];
                thinkingSteps[stepIndex].searchInfo = searchInfo;
                
                return stepIndex;
            }
            
            // "ìƒê°í•˜ëŠ” ê³¼ì •" UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
            function updateThinkingProcessUI() {
                if (!thinkingProcessUI) {
                    thinkingProcessUI = createThinkingProcessUI(thinkingSteps);
                } else {
                    const content = thinkingProcessUI.querySelector('.thinking-content');
                    if (content) {
                        content.innerHTML = '';
                        
                        // ë‚´ìš©ì´ ìˆëŠ” ë‹¨ê³„ë§Œ í•„í„°ë§
                        const stepsWithContent = thinkingSteps.filter(step => step.content && step.content.trim());
                        
                        // í—¤ë”ì˜ ë‹¨ê³„ ìˆ˜ ì—…ë°ì´íŠ¸
                        const header = thinkingProcessUI.querySelector('.thinking-header');
                        if (header) {
                            const titleSpan = header.querySelector('.thinking-title span');
                            if (titleSpan) {
                                titleSpan.textContent = `ğŸ¤” ìƒê°í•˜ëŠ” ê³¼ì • (${stepsWithContent.length}ë‹¨ê³„)`;
                            }
                        }
                        
                        stepsWithContent.forEach(step => {
                            const stepDiv = document.createElement('div');
                            stepDiv.className = 'thinking-step';
                            
                            let stepHTML = `<div class="thinking-step-title">${step.title}</div>`;
                            if (step.content) {
                                stepHTML += `<div class="thinking-step-content">${step.content}</div>`;
                            }
                            
                            stepDiv.innerHTML = stepHTML;
                            content.appendChild(stepDiv);
                        });
                    }
                }
            }
            
            try {
                const response = await fetch('/api/chat/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        session_id: sessionId
                    }),
                    signal: currentAbortController.signal
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                
                                if (data.type === 'token') {
                                    // í† í° ë ˆë²¨ ìŠ¤íŠ¸ë¦¬ë° (ê¸€ì ë‹¨ìœ„)
                                    fullContent += data.content;
                                    
                                    // JSON ë¸”ë¡ ê°ì§€ ë° ì¶”ì¶œ (ë” ì •í™•í•œ ë°©ë²•)
                                    // {ë¡œ ì‹œì‘í•´ì„œ }ë¡œ ëë‚˜ëŠ” ë¸”ë¡ ì°¾ê¸° (ì¤‘ì²©ëœ ì¤‘ê´„í˜¸ ê³ ë ¤)
                                    let jsonStart = fullContent.indexOf('{');
                                    const foundJsonBlocks = [];
                                    
                                    while (jsonStart !== -1) {
                                        let braceCount = 0;
                                        let jsonEnd = -1;
                                        
                                        for (let i = jsonStart; i < fullContent.length; i++) {
                                            if (fullContent[i] === '{') braceCount++;
                                            if (fullContent[i] === '}') braceCount--;
                                            if (braceCount === 0) {
                                                jsonEnd = i + 1;
                                                break;
                                            }
                                        }
                                        
                                        if (jsonEnd > jsonStart) {
                                            const jsonText = fullContent.substring(jsonStart, jsonEnd);
                                            
                                            // JSON í‚¤ì›Œë“œ í™•ì¸ (ë‚´ë¶€ ì²˜ë¦¬ ì •ë³´ì¸ì§€ í™•ì¸)
                                            if (jsonText.includes('"search_queries"') || 
                                                jsonText.includes('"research_plan"') || 
                                                jsonText.includes('"priority"') ||
                                                jsonText.includes('"score"') || 
                                                jsonText.includes('"is_sufficient"') || 
                                                jsonText.includes('"feedback"') ||
                                                jsonText.includes('"missing_information"')) {
                                                
                                                try {
                                                    const parsed = JSON.parse(jsonText);
                                                    // ì´ë¯¸ ìˆ˜ì§‘ëœ ë¸”ë¡ì¸ì§€ í™•ì¸ (ì›ë³¸ í…ìŠ¤íŠ¸ë¡œ ë¹„êµ)
                                                    const isNew = !foundJsonBlocks.some(block => block.text === jsonText);
                                                    
                                                    if (isNew) {
                                                        foundJsonBlocks.push({ text: jsonText, parsed: parsed });
                                                        // jsonBlocksì— ì¶”ê°€ (ì¤‘ë³µ ì²´í¬)
                                                        const alreadyExists = jsonBlocks.some(block => block.text === jsonText);
                                                        if (!alreadyExists) {
                                                            jsonBlocks.push({ text: jsonText, parsed: parsed });
                                                            console.log('JSON ë¸”ë¡ ê°ì§€ë¨:', jsonText.substring(0, 100) + '...');
                                                            
                                                            const steps = parseThinkingProcess(jsonText);
                                                            console.log('ìƒê°í•˜ëŠ” ê³¼ì • ë‹¨ê³„:', steps);
                                                            if (steps.length > 0) {
                                                                thinkingSteps.push(...steps);
                                                                
                                                                // "ìƒê°í•˜ëŠ” ê³¼ì •" UIëŠ” ë‚˜ì¤‘ì— í‘œì‹œ (ë‹µë³€ ì™„ë£Œ í›„)
                                                                shouldShowThinkingProcess = true;
                                                                if (!thinkingProcessUI) {
                                                                    thinkingProcessUI = createThinkingProcessUI(thinkingSteps);
                                                                } else {
                                                                    // ê¸°ì¡´ UI ì—…ë°ì´íŠ¸
                                                                    const content = thinkingProcessUI.querySelector('.thinking-content');
                                                                    if (content) {
                                                                        content.innerHTML = '';
                                                                        thinkingSteps.forEach(step => {
                                                                            const stepDiv = document.createElement('div');
                                                                            stepDiv.className = 'thinking-step';
                                                                            let stepHTML = `<div class="thinking-step-title">${step.title}</div>`;
                                                                            stepHTML += `<div class="thinking-step-content">${step.content}</div>`;
                                                                            if (step.queries && step.queries.length > 0) {
                                                                                stepHTML += '<ul>';
                                                                                step.queries.slice(0, 3).forEach(query => {
                                                                                    stepHTML += `<li>${query}</li>`;
                                                                                });
                                                                                if (step.queries.length > 3) {
                                                                                    stepHTML += `<li>... ì™¸ ${step.queries.length - 3}ê°œ</li>`;
                                                                                }
                                                                                stepHTML += '</ul>';
                                                                            }
                                                                            stepDiv.innerHTML = stepHTML;
                                                                            content.appendChild(stepDiv);
                                                                        });
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                } catch (e) {
                                                    console.error('JSON íŒŒì‹± ì‹¤íŒ¨:', e, jsonText.substring(0, 100));
                                                }
                                            }
                                            
                                            // ë‹¤ìŒ { ì°¾ê¸°
                                            jsonStart = fullContent.indexOf('{', jsonEnd);
                                        } else {
                                            break;
                                        }
                                    }
                                    
                                    // JSON ë¸”ë¡ ì œê±° í›„ ì‹¤ì œ ì½˜í…ì¸ ë§Œ í‘œì‹œ (ì›ë³¸ í…ìŠ¤íŠ¸ë¡œ ì œê±°)
                                    let displayContent = fullContent;
                                    
                                    // ëª¨ë“  JSON ë¸”ë¡ì„ ì œê±° (ê¸´ ê²ƒë¶€í„° ì§§ì€ ê²ƒ ìˆœì„œë¡œ ì •ë ¬í•˜ì—¬ ì œê±°)
                                    const sortedBlocks = [...jsonBlocks].sort((a, b) => b.text.length - a.text.length);
                                    sortedBlocks.forEach(jsonBlock => {
                                        // ì›ë³¸ í…ìŠ¤íŠ¸ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì—¬ ì œê±° (ì •ê·œì‹ ì´ìŠ¤ì¼€ì´í”„)
                                        const escapedText = jsonBlock.text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                                        displayContent = displayContent.replace(new RegExp(escapedText, 'g'), '').trim();
                                    });
                                    
                                    // ì—¬ëŸ¬ JSON ë¸”ë¡ì´ ì—°ì†ëœ ê²½ìš° ì¶”ê°€ ì²˜ë¦¬ (ë” ê°•ë ¥í•œ ì •ê·œì‹)
                                    displayContent = displayContent.replace(/^\s*\{[\s\S]*?\}\s*\{[\s\S]*?\}\s*/g, '');
                                    displayContent = displayContent.replace(/^\s*\{[\s\S]*?\}\s*/g, '');
                                    
                                    // JSON í‚¤ì›Œë“œê°€ ë‚¨ì•„ìˆìœ¼ë©´ ì¶”ê°€ ì œê±° ì‹œë„
                                    if (displayContent.includes('"search_queries"') || 
                                        displayContent.includes('"research_plan"') || 
                                        displayContent.includes('"score"')) {
                                        // {ë¡œ ì‹œì‘í•˜ëŠ” ëª¨ë“  ë¸”ë¡ ì œê±° ì‹œë„
                                        displayContent = displayContent.replace(/\{[\s\S]*?\}/g, function(match) {
                                            if (match.includes('"search_queries"') || 
                                                match.includes('"research_plan"') || 
                                                match.includes('"score"') ||
                                                match.includes('"priority"') ||
                                                match.includes('"is_sufficient"') ||
                                                match.includes('"feedback"')) {
                                                return '';
                                            }
                                            return match;
                                        }).trim();
                                    }
                                    
                                    hasReceivedToken = true;  // í† í° ìˆ˜ì‹  í‘œì‹œ
                                    const formattedContent = formatMessage(displayContent);
                                    bubble.innerHTML = formattedContent + '<span class="streaming-cursor">â–Š</span>';
                                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                                } else if (data.type === 'content') {
                                    // ê¸°ì¡´ ë°©ì‹ í˜¸í™˜ (ì²­í¬ ë‹¨ìœ„)
                                    fullContent += data.content;
                                    hasReceivedToken = true;  // í† í° ìˆ˜ì‹  í‘œì‹œ
                                    // ë…¸ë“œ ìƒíƒœë¥¼ ì™„ì „íˆ ì œê±°í•˜ê³  ì‹¤ì œ ì½˜í…ì¸ ë§Œ í‘œì‹œ
                                    const formattedContent = formatMessage(fullContent);
                                    bubble.innerHTML = formattedContent + '<span class="streaming-cursor">â–Š</span>';
                                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                                } else if (data.type === 'node') {
                                    // ë…¸ë“œ ì§„í–‰ ìƒí™© í‘œì‹œ ë° ë…¸ë“œ ì´ë ¥ ì €ì¥
                                    const nodeName = data.node || '';
                                    const displayName = data.display || '';
                                    
                                    console.log('ë…¸ë“œ ì§„í–‰:', displayName, 'ë…¸ë“œëª…:', nodeName);
                                    
                                    // "ìƒê°í•˜ëŠ” ê³¼ì •" ë‹¨ê³„ ì¶”ê°€ ë˜ëŠ” ì—…ë°ì´íŠ¸ (ê³µí†µ í•¨ìˆ˜ ì‚¬ìš©)
                                    const searchInfo = nodeSearchInfo[nodeName] || {};
                                    const stepIndex = addOrUpdateThinkingStep(nodeName, displayName, searchInfo);
                                    
                                    if (stepIndex !== -1) {
                                        shouldShowThinkingProcess = true;
                                        updateThinkingProcessUI();
                                    }
                                    
                                    // ì‘ë‹µ ìƒì„± ë…¸ë“œ ì¶”ì 
                                    if (nodeName && ['writer', 'faq_specialist', 'transaction_specialist', 'hybrid_specialist', 'intent_clarifier', 'simple_chat_specialist'].includes(nodeName)) {
                                        currentResponseNode = nodeName;
                                    }
                                    
                                    // í† í°ì„ ë°›ì§€ ì•Šì•˜ì„ ë•Œë§Œ ë…¸ë“œ ìƒíƒœ í‘œì‹œ
                                    if (!hasReceivedToken && (!fullContent || fullContent.trim() === '')) {
                                        bubble.innerHTML = `<span class="node-status">${displayName}</span><span class="streaming-cursor">â–Š</span>`;
                                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                                    }
                                } else if (data.type === 'node_search') {
                                    // ë…¸ë“œë³„ ê²€ìƒ‰ ì •ë³´ ìˆ˜ì‹  (ê³µí†µ í•¨ìˆ˜ ì‚¬ìš©)
                                    const nodeName = data.node || '';
                                    const searchInfo = data.search_info || {};
                                    
                                    console.log('ê²€ìƒ‰ ì •ë³´ ìˆ˜ì‹ :', nodeName, searchInfo);
                                    
                                    // simple_chat_specialistì™€ transaction_specialistëŠ” "ìƒê°í•˜ëŠ” ê³¼ì •"ì— í¬í•¨í•˜ì§€ ì•ŠìŒ
                                    if (nodeName === 'simple_chat_specialist' || nodeName === 'transaction_specialist') {
                                        // ê²€ìƒ‰ ì •ë³´ë„ ì €ì¥í•˜ì§€ ì•ŠìŒ
                                        return;
                                    }
                                    
                                    // ê²€ìƒ‰ ì •ë³´ ì €ì¥
                                    nodeSearchInfo[nodeName] = searchInfo;
                                    
                                    // "ìƒê°í•˜ëŠ” ê³¼ì •" ë‹¨ê³„ ì¶”ê°€ ë˜ëŠ” ì—…ë°ì´íŠ¸
                                    const nodeDisplay = nodeHistory.find(n => n.name === nodeName)?.display || NODE_DISPLAY_NAMES[nodeName] || nodeName;
                                    const stepIndex = addOrUpdateThinkingStep(nodeName, nodeDisplay, searchInfo);
                                    
                                    if (stepIndex !== -1) {
                                        shouldShowThinkingProcess = true;
                                        updateThinkingProcessUI();
                                    }
                                } else if (data.type === 'done') {
                                    // ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ - JSON ì œê±° í›„ ìµœì¢… ì‘ë‹µë§Œ í‘œì‹œ
                                    let finalText = fullContent || data.final_response || '';
                                    
                                    // JSON ë¸”ë¡ ì œê±° (ì›ë³¸ í…ìŠ¤íŠ¸ë¡œ ì œê±°)
                                    jsonBlocks.forEach(jsonBlock => {
                                        finalText = finalText.replace(jsonBlock.text, '').trim();
                                    });
                                    finalText = finalText.replace(/^\s*\{[\s\S]*?\}\s*\{[\s\S]*?\}\s*/g, '');
                                    finalText = finalText.replace(/^\s*\{[\s\S]*?\}\s*/g, '');
                                    
                                    const formattedContent = formatMessage(finalText);
                                    bubble.innerHTML = formattedContent;
                                    
                                    // ë‹µë³€ ì™„ë£Œ í›„ "ìƒê°í•˜ëŠ” ê³¼ì •" UIë¥¼ ë‹µë³€ ì•„ë˜ì— ì¶”ê°€
                                    // simple_chat_specialistì™€ transaction_specialistê°€ ì‘ë‹µì„ ìƒì„±í•œ ê²½ìš°ëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŒ
                                    if (currentResponseNode === 'simple_chat_specialist' || currentResponseNode === 'transaction_specialist') {
                                        // "ìƒê°í•˜ëŠ” ê³¼ì •" UIë¥¼ í‘œì‹œí•˜ì§€ ì•ŠìŒ
                                        shouldShowThinkingProcess = false;
                                    } else {
                                        // simple_chat_specialistì™€ transaction_specialistëŠ” ì œì™¸
                                        const filteredNodeSearchInfo = Object.fromEntries(
                                            Object.entries(nodeSearchInfo).filter(([nodeName]) => 
                                                nodeName !== 'simple_chat_specialist' && nodeName !== 'transaction_specialist'
                                            )
                                        );
                                        
                                        // thinkingStepsê°€ ìˆê±°ë‚˜ ê²€ìƒ‰ ì •ë³´ê°€ ìˆìœ¼ë©´ í‘œì‹œ (ì œì™¸ëœ ë…¸ë“œ ì œì™¸)
                                        if (thinkingSteps.length > 0 || Object.keys(filteredNodeSearchInfo).length > 0) {
                                            shouldShowThinkingProcess = true;
                                            
                                            // thinkingProcessUIê°€ ì—†ìœ¼ë©´ ìƒì„±
                                            if (!thinkingProcessUI && thinkingSteps.length > 0) {
                                                thinkingProcessUI = createThinkingProcessUI(thinkingSteps);
                                            } else if (thinkingProcessUI) {
                                                // ê¸°ì¡´ UI ì—…ë°ì´íŠ¸
                                                updateThinkingProcessUI();
                                            }
                                            
                                            // UIê°€ ìˆê³  ì•„ì§ DOMì— ì¶”ê°€ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì¶”ê°€
                                            if (thinkingProcessUI && !messageDiv.contains(thinkingProcessUI)) {
                                                messageDiv.appendChild(thinkingProcessUI);
                                            }
                                            
                                            // ì ‘íŒ ìƒíƒœë¡œ ìœ ì§€
                                            if (thinkingProcessUI) {
                                                thinkingProcessUI.classList.add('collapsed');
                                                thinkingProcessUI.classList.remove('expanded');
                                            }
                                        }
                                    }
                                    
                                    sendBtn.disabled = false;
                                } else if (data.type === 'error') {
                                    // ì—ëŸ¬ ë°œìƒ ì‹œ ë…¸ë“œ ìƒíƒœì™€ ì»¤ì„œ ì™„ì „íˆ ì œê±°
                                    bubble.innerHTML = formatMessage('ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + data.content);
                                    sendBtn.disabled = false;
                                }
                            } catch (parseError) {
                                console.error('SSE íŒŒì‹± ì˜¤ë¥˜:', parseError);
                            }
                        }
                    }
                }
                
                // ì™„ë£Œ í›„ ì •ë¦¬: JSON ì œê±° í›„ ìµœì¢… ì½˜í…ì¸ ë§Œ í‘œì‹œ
                let finalContent = fullContent;
                
                // JSON ë¸”ë¡ ì œê±° (ì›ë³¸ í…ìŠ¤íŠ¸ë¡œ ì œê±°)
                jsonBlocks.forEach(jsonBlock => {
                    finalContent = finalContent.replace(jsonBlock.text, '').trim();
                });
                finalContent = finalContent.replace(/^\s*\{[\s\S]*?\}\s*\{[\s\S]*?\}\s*/g, '');
                finalContent = finalContent.replace(/^\s*\{[\s\S]*?\}\s*/g, '');
                
                const finalFormattedContent = formatMessage(finalContent);
                bubble.innerHTML = finalFormattedContent;
                
                // ë‹µë³€ ì™„ë£Œ í›„ "ìƒê°í•˜ëŠ” ê³¼ì •" UIë¥¼ ë‹µë³€ ì•„ë˜ì— ì¶”ê°€
                // simple_chat_specialistì™€ transaction_specialistê°€ ì‘ë‹µì„ ìƒì„±í•œ ê²½ìš°ëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŒ
                if (currentResponseNode === 'simple_chat_specialist' || currentResponseNode === 'transaction_specialist') {
                    // "ìƒê°í•˜ëŠ” ê³¼ì •" UIë¥¼ í‘œì‹œí•˜ì§€ ì•ŠìŒ
                    shouldShowThinkingProcess = false;
                } else {
                    // simple_chat_specialistì™€ transaction_specialistëŠ” ì œì™¸
                    const filteredNodeSearchInfo = Object.fromEntries(
                        Object.entries(nodeSearchInfo).filter(([nodeName]) => 
                            nodeName !== 'simple_chat_specialist' && nodeName !== 'transaction_specialist'
                        )
                    );
                    
                    // thinkingStepsê°€ ìˆê±°ë‚˜ ê²€ìƒ‰ ì •ë³´ê°€ ìˆìœ¼ë©´ í‘œì‹œ (ì œì™¸ëœ ë…¸ë“œ ì œì™¸)
                    if (thinkingSteps.length > 0 || Object.keys(filteredNodeSearchInfo).length > 0) {
                        shouldShowThinkingProcess = true;
                        
                        // thinkingProcessUIê°€ ì—†ìœ¼ë©´ ìƒì„±
                        if (!thinkingProcessUI && thinkingSteps.length > 0) {
                            thinkingProcessUI = createThinkingProcessUI(thinkingSteps);
                        } else if (thinkingProcessUI) {
                            // ê¸°ì¡´ UI ì—…ë°ì´íŠ¸
                            updateThinkingProcessUI();
                        }
                        
                        // UIê°€ ìˆê³  ì•„ì§ DOMì— ì¶”ê°€ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì¶”ê°€
                        if (thinkingProcessUI && !messageDiv.contains(thinkingProcessUI)) {
                            messageDiv.appendChild(thinkingProcessUI);
                        }
                        
                        // ì ‘íŒ ìƒíƒœë¡œ ìœ ì§€
                        if (thinkingProcessUI) {
                            thinkingProcessUI.classList.add('collapsed');
                            thinkingProcessUI.classList.remove('expanded');
                        }
                    }
                }
                
                sendBtn.disabled = false;
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('ìš”ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    console.error('ìŠ¤íŠ¸ë¦¬ë° ì˜¤ë¥˜:', error);
                    bubble.innerHTML = formatMessage('ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
                sendBtn.disabled = false;
            }
        }

        async function sendMessageNormal(message, sendBtn) {
            // ë¡œë”© í‘œì‹œ
            const loadingId = showLoading();
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        session_id: sessionId
                    }),
                    signal: currentAbortController.signal
                });
                
                const data = await response.json();
                
                // ë¡œë”© ì œê±°
                hideLoading(loadingId);
                sendBtn.disabled = false;
                
                if (data.error) {
                    addMessageToChat('assistant', 'ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + data.error);
                } else {
                    addMessageToChat('assistant', data.response);
                }
                
            } catch (error) {
                hideLoading(loadingId);
                sendBtn.disabled = false;
                if (error.name !== 'AbortError') {
                    addMessageToChat('assistant', 'ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    console.error('Error:', error);
                }
            }
        }

        function addMessageToChat(role, content, scroll = true) {
            const messagesContainer = document.getElementById('chatMessages');
            
            // ë¹ˆ ìƒíƒœ ë©”ì‹œì§€ ì œê±°
            const emptyState = messagesContainer.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            
            // í…ìŠ¤íŠ¸ë¥¼ ì²˜ë¦¬í•˜ì—¬ ê°€ë…ì„± í–¥ìƒ
            const formattedContent = formatMessage(content);
            bubble.innerHTML = formattedContent;
            
            messageDiv.appendChild(bubble);
            messagesContainer.appendChild(messageDiv);
            
            if (scroll) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        function formatMessage(text) {
            if (!text) return '';
            
            // ì½”ë“œ ë¸”ë¡ ë¨¼ì € ì²˜ë¦¬ (ì¤‘ê´„í˜¸ ì´ìŠ¤ì¼€ì´í”„ ë°©ì§€)
            const codeBlocks = [];
            let codeBlockIndex = 0;
            text = text.replace(/```([\s\S]*?)```/g, (match, code) => {
                const placeholder = `__CODE_BLOCK_${codeBlockIndex}__`;
                codeBlocks[codeBlockIndex] = code;
                codeBlockIndex++;
                return placeholder;
            });
            
            // HTML ì´ìŠ¤ì¼€ì´í”„
            let html = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            
            // ì½”ë“œ ë¸”ë¡ ë³µì›
            codeBlocks.forEach((code, index) => {
                const escapedCode = code
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
                html = html.replace(`__CODE_BLOCK_${index}__`, `<pre><code>${escapedCode}</code></pre>`);
            });
            
            // ì¸ë¼ì¸ ì½”ë“œ ì²˜ë¦¬ (`ì½”ë“œ` -> <code>ì½”ë“œ</code>)
            html = html.replace(/`([^`\n]+)`/g, '<code>$1</code>');
            
            // ê°•ì¡° í‘œì‹œ (**í…ìŠ¤íŠ¸** -> <strong>í…ìŠ¤íŠ¸</strong>)
            html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            
            // ë§í¬ ë³€í™˜ (http/https URL)
            html = html.replace(
                /(https?:\/\/[^\s<>]+)/g,
                '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'
            );
            
            // ì¤„ ë‹¨ìœ„ë¡œ ì²˜ë¦¬
            const lines = html.split('\n');
            const processedLines = [];
            let inList = false;
            let listType = null;
            let listItems = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                // ìˆ«ìë¡œ ì‹œì‘í•˜ëŠ” ë¦¬ìŠ¤íŠ¸ (1. 2. 3. ...)
                const numberedMatch = line.match(/^(\d+)\.\s+(.+)$/);
                if (numberedMatch) {
                    if (!inList || listType !== 'ol') {
                        if (inList && listItems.length > 0) {
                            processedLines.push(`<${listType}>${listItems.join('')}</${listType}>`);
                            listItems = [];
                        }
                        inList = true;
                        listType = 'ol';
                    }
                    listItems.push(`<li>${numberedMatch[2]}</li>`);
                    continue;
                }
                
                // ë¶ˆë¦¿ í¬ì¸íŠ¸ ë¦¬ìŠ¤íŠ¸ (- ë˜ëŠ” â€¢)
                const bulletMatch = line.match(/^[-â€¢]\s+(.+)$/);
                if (bulletMatch) {
                    if (!inList || listType !== 'ul') {
                        if (inList && listItems.length > 0) {
                            processedLines.push(`<${listType}>${listItems.join('')}</${listType}>`);
                            listItems = [];
                        }
                        inList = true;
                        listType = 'ul';
                    }
                    listItems.push(`<li>${bulletMatch[1]}</li>`);
                    continue;
                }
                
                // ë¦¬ìŠ¤íŠ¸ ì¢…ë£Œ
                if (inList && line === '') {
                    if (listItems.length > 0) {
                        processedLines.push(`<${listType}>${listItems.join('')}</${listType}>`);
                        listItems = [];
                    }
                    inList = false;
                    listType = null;
                    processedLines.push('<br>');
                    continue;
                }
                
                // ì¼ë°˜ í…ìŠ¤íŠ¸ ì¤„
                if (line === '') {
                    processedLines.push('<br>');
                } else {
                    processedLines.push(line);
                }
            }
            
            // ë§ˆì§€ë§‰ ë¦¬ìŠ¤íŠ¸ ì²˜ë¦¬
            if (inList && listItems.length > 0) {
                processedLines.push(`<${listType}>${listItems.join('')}</${listType}>`);
            }
            
            html = processedLines.join(' ');
            
            // ì—°ì†ëœ <br>ë¥¼ ë‹¨ë½ êµ¬ë¶„ìœ¼ë¡œ ë³€í™˜
            html = html.replace(/(<br>\s*){2,}/g, '</p><p>');
            html = '<p>' + html + '</p>';
            html = html.replace(/<p>\s*<\/p>/g, ''); // ë¹ˆ ë‹¨ë½ ì œê±°
            html = html.replace(/<p>(<pre>)/g, '$1'); // ì½”ë“œ ë¸”ë¡ ì•ì˜ <p> ì œê±°
            html = html.replace(/(<\/pre>)<\/p>/g, '$1'); // ì½”ë“œ ë¸”ë¡ ë’¤ì˜ </p> ì œê±°
            
            return html;
        }

        function showLoading() {
            const messagesContainer = document.getElementById('chatMessages');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message assistant';
            loadingDiv.id = 'loadingMessage';
            
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble loading';
            bubble.innerHTML = `
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
            `;
            
            loadingDiv.appendChild(bubble);
            messagesContainer.appendChild(loadingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return 'loadingMessage';
        }

        function hideLoading(loadingId) {
            const loading = document.getElementById(loadingId);
            if (loading) {
                loading.remove();
            }
        }

        async function clearChat() {
            if (!confirm('ëŒ€í™” ê¸°ë¡ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/chat/history/${sessionId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const messagesContainer = document.getElementById('chatMessages');
                    messagesContainer.innerHTML = `
                        <div class="empty-state">
                            <h2>ì•ˆë…•í•˜ì„¸ìš”! ğŸ‘‹</h2>
                            <p>ë¸”ë¡ì²´ì¸ íŠ¸ëœì­ì…˜ ì¡°íšŒì™€ ê´€ë ¨ëœ ì§ˆë¬¸ì„ í•´ì£¼ì„¸ìš”.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('ëŒ€í™” ê¸°ë¡ ì‚­ì œ ì‹¤íŒ¨:', error);
                alert('ëŒ€í™” ê¸°ë¡ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
    </script>
</body>
</html>


