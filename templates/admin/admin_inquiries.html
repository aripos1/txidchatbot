{% extends "base.html" %}

{% block title %}ë¬¸ì˜ì‚¬í•­ ê´€ë¦¬{% endblock %}

{% block meta_description %}ë¬¸ì˜ì‚¬í•­ì„ í™•ì¸í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”.{% endblock %}

{% block styles %}
<link rel="stylesheet" href="/static/css/admin.css">
{% endblock %}

{% block content %}
<div class="admin-page" x-data="adminData()" x-init="init()">
    {% include "admin/components/sidebar.html" %}
    
    <div class="admin-wrapper">
        <div class="admin-container">
            <div class="admin-header">
                <div class="admin-header-top">
                    <h1 class="admin-title">ë¬¸ì˜ì‚¬í•­ ê´€ë¦¬</h1>
                </div>
            <div class="admin-stats">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-label">ì „ì²´</div>
                        <div class="stat-icon">ğŸ“Š</div>
                    </div>
                    <div class="stat-value" x-text="totalCount">0</div>
                </div>
                <div class="stat-card stat-pending">
                    <div class="stat-card-header">
                        <div class="stat-label">ëŒ€ê¸°ì¤‘</div>
                        <div class="stat-icon">â³</div>
                    </div>
                    <div class="stat-value" x-text="pendingCount">0</div>
                </div>
                <div class="stat-card stat-replied">
                    <div class="stat-card-header">
                        <div class="stat-label">ë‹µë³€ì™„ë£Œ</div>
                        <div class="stat-icon">âœ…</div>
                    </div>
                    <div class="stat-value" x-text="repliedCount">0</div>
                </div>
                <div class="stat-card stat-closed">
                    <div class="stat-card-header">
                        <div class="stat-label">ì¢…ë£Œ</div>
                        <div class="stat-icon">ğŸ”’</div>
                    </div>
                    <div class="stat-value" x-text="closedCount">0</div>
                </div>
            </div>
        </div>

        <div class="admin-filters">
            <select x-model="filterStatus" @change="loadInquiries()" class="filter-select">
                <option value="">ì „ì²´</option>
                <option value="pending">ëŒ€ê¸°ì¤‘</option>
                <option value="replied">ë‹µë³€ì™„ë£Œ</option>
                <option value="closed">ì¢…ë£Œ</option>
            </select>
            <button @click="loadInquiries()" class="btn btn-primary">ìƒˆë¡œê³ ì¹¨</button>
            <a href="/admin/chat/stats" class="btn btn-outline">ì±„íŒ… í†µê³„</a>
        </div>

        <div class="inquiries-list" x-show="!loading && inquiries.length > 0">
            <template x-for="inquiry in inquiries" :key="inquiry._id">
                <div class="inquiry-card" :class="'status-' + inquiry.status">
                    <div class="inquiry-header">
                        <div class="inquiry-meta">
                            <span class="inquiry-id" x-text="'#' + inquiry._id.slice(-8)"></span>
                            <span class="inquiry-category" x-text="getCategoryName(inquiry.category)"></span>
                            <span class="inquiry-status" :class="'status-' + inquiry.status" x-text="getStatusName(inquiry.status)"></span>
                        </div>
                        <div class="inquiry-date" x-text="formatDate(inquiry.created_at)"></div>
                    </div>
                    <div class="inquiry-email" x-text="inquiry.email"></div>
                    <h3 class="inquiry-subject" x-text="inquiry.subject"></h3>
                    <div class="inquiry-message" x-text="inquiry.message"></div>
                    <div class="inquiry-actions">
                        <template x-if="inquiry.status === 'pending'">
                            <button @click="updateStatus(inquiry._id, 'replied')" class="btn-action btn-replied">ë‹µë³€ì™„ë£Œ</button>
                        </template>
                        <template x-if="inquiry.status !== 'closed'">
                            <button @click="updateStatus(inquiry._id, 'closed')" class="btn-action btn-closed">ì¢…ë£Œ</button>
                        </template>
                        <template x-if="inquiry.status === 'closed'">
                            <button @click="updateStatus(inquiry._id, 'pending')" class="btn-action btn-reopen">ë‹¤ì‹œ ì—´ê¸°</button>
                        </template>
                    </div>
                </div>
            </template>
        </div>

        <div class="empty-state" x-show="!loading && inquiries.length === 0">
            <p>ë¬¸ì˜ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>

        <div class="loading-state" x-show="loading">
            <div class="loading-spinner"></div>
            <p>ë¡œë”© ì¤‘...</p>
        </div>
    </div>

    <!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ -->
    <div x-show="showChangePasswordModal" 
         x-cloak
         class="modal-overlay"
         @click.self="showChangePasswordModal = false">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h2>
                <button type="button" 
                        class="modal-close"
                        @click="showChangePasswordModal = false; passwordForm = {current_password: '', new_password: '', confirm_password: '', error: ''}">
                    Ã—
                </button>
            </div>
            <form @submit.prevent="changePassword()" class="modal-body">
                <div class="form-group">
                    <label class="form-label">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" 
                           class="form-input"
                           x-model="passwordForm.current_password" 
                           required
                           placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸">
                </div>
                <div class="form-group">
                    <label class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" 
                           class="form-input"
                           x-model="passwordForm.new_password" 
                           required
                           minlength="6"
                           placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ (ìµœì†Œ 6ì)">
                </div>
                <div class="form-group">
                    <label class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                    <input type="password" 
                           class="form-input"
                           x-model="passwordForm.confirm_password" 
                           required
                           minlength="6"
                           placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸">
                </div>
                <div x-show="passwordForm.error" 
                     x-text="passwordForm.error"
                     class="form-error"></div>
            </form>
            <div class="modal-footer">
                <button type="button" 
                        class="btn btn-secondary"
                        @click="showChangePasswordModal = false; passwordForm = {current_password: '', new_password: '', confirm_password: '', error: ''}">
                    ì·¨ì†Œ
                </button>
                <button type="submit" 
                        class="btn btn-primary"
                        :disabled="passwordForm.loading"
                        @click="changePassword()">
                    <span x-show="!passwordForm.loading">ë³€ê²½</span>
                    <span x-show="passwordForm.loading">ë³€ê²½ ì¤‘...</span>
                </button>
            </div>
        </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function adminData() {
    return {
        inquiries: [],
        loading: false,
        filterStatus: '',
        totalCount: 0,
        pendingCount: 0,
        repliedCount: 0,
        closedCount: 0,
        showChangePasswordModal: false,
        passwordForm: {
            current_password: '',
            new_password: '',
            confirm_password: '',
            error: '',
            loading: false
        },
        
        async init() {
            // í†µê³„ì™€ ë¬¸ì˜ì‚¬í•­ì„ ë™ì‹œì— ë¡œë“œ (ë³‘ë ¬ ì²˜ë¦¬)
            try {
                await Promise.all([
                    this.loadStats(),
                    this.loadInquiries()
                ]);
            } catch (error) {
                console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                // ì¸ì¦ ì˜¤ë¥˜ í™•ì¸
                const statsResponse = await fetch('/api/admin/inquiries/stats', {
                    credentials: 'include'
                });
                if (statsResponse.status === 401) {
                    window.location.href = '/admin/login?redirect=' + encodeURIComponent(window.location.pathname);
                }
            }
        },
        
        async loadStats() {
            try {
                const response = await fetch('/api/admin/inquiries/stats', {
                    credentials: 'include'
                });
                if (response.ok) {
                    const data = await response.json();
                    // ë°ì´í„°ê°€ ìˆì„ ë•Œë§Œ ì—…ë°ì´íŠ¸ (0ì´ì–´ë„ ìœ íš¨í•œ ê°’)
                    this.totalCount = data.total ?? 0;
                    this.pendingCount = data.pending ?? 0;
                    this.repliedCount = data.replied ?? 0;
                    this.closedCount = data.closed ?? 0;
                } else if (response.status === 401) {
                    window.location.href = '/admin/login?redirect=' + encodeURIComponent(window.location.pathname);
                    throw new Error('ì¸ì¦ í•„ìš”');
                } else {
                    console.error('í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', response.status);
                }
            } catch (error) {
                console.error('Stats load error:', error);
                // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ê¸°ë³¸ê°’ ìœ ì§€ (0ìœ¼ë¡œ í‘œì‹œ)
            }
        },
        
        
        async loadInquiries() {
            this.loading = true;
            try {
                const params = new URLSearchParams();
                if (this.filterStatus) {
                    params.append('status', this.filterStatus);
                }
                
                const response = await fetch('/api/admin/inquiries?' + params.toString(), {
                    credentials: 'include'
                });
                if (response.ok) {
                    const data = await response.json();
                    // API ì‘ë‹µ í˜•ì‹: {"success": True, "inquiries": [...]}
                    if (data.success !== undefined && Array.isArray(data.inquiries)) {
                        this.inquiries = data.inquiries;
                    } else if (Array.isArray(data.inquiries)) {
                        // success í•„ë“œê°€ ì—†ì–´ë„ inquiries ë°°ì—´ì´ ìˆìœ¼ë©´ ì‚¬ìš©
                        this.inquiries = data.inquiries;
                    } else if (Array.isArray(data)) {
                        // ì§ì ‘ ë°°ì—´ë¡œ ë°˜í™˜ëœ ê²½ìš°
                        this.inquiries = data;
                    } else {
                        console.warn('ì˜ˆìƒì¹˜ ëª»í•œ ë°ì´í„° í˜•ì‹:', data);
                        this.inquiries = [];
                    }
                } else if (response.status === 401) {
                    window.location.href = '/admin/login?redirect=' + encodeURIComponent(window.location.pathname);
                    throw new Error('ì¸ì¦ í•„ìš”');
                } else {
                    console.error('ë¬¸ì˜ì‚¬í•­ ë¡œë“œ ì‹¤íŒ¨:', response.status);
                    // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ë¹ˆ ë°°ì—´ë¡œ ì„¤ì •í•˜ì—¬ UIê°€ ê¹¨ì§€ì§€ ì•Šë„ë¡
                    this.inquiries = [];
                }
            } catch (error) {
                console.error('Error:', error);
                // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë“±ìœ¼ë¡œ ì‹¤íŒ¨í•œ ê²½ìš° ë¹ˆ ë°°ì—´ë¡œ ì„¤ì •
                this.inquiries = [];
            } finally {
                this.loading = false;
            }
        },
        
        async updateStatus(inquiryId, status) {
            if (!confirm('ìƒíƒœë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/inquiries/${inquiryId}/status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        status: status
                    })
                });
                
                if (response.ok) {
                    // ìƒíƒœ ë³€ê²½ í›„ í†µê³„ì™€ ëª©ë¡ì„ ë™ì‹œì— ì—…ë°ì´íŠ¸
                    await Promise.all([
                        this.loadStats(),
                        this.loadInquiries()
                    ]);
                } else if (response.status === 401) {
                    window.location.href = '/admin/login?redirect=' + encodeURIComponent(window.location.pathname);
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    alert(errorData.message || 'ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        },
        
        async changePassword() {
            // ì…ë ¥ ê²€ì¦
            if (!this.passwordForm.current_password || !this.passwordForm.new_password || !this.passwordForm.confirm_password) {
                this.passwordForm.error = 'ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                return;
            }
            
            if (this.passwordForm.new_password !== this.passwordForm.confirm_password) {
                this.passwordForm.error = 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                return;
            }
            
            if (this.passwordForm.new_password.length < 6) {
                this.passwordForm.error = 'ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
                return;
            }
            
            this.passwordForm.error = '';
            this.passwordForm.loading = true;
            
            try {
                const response = await fetch('/api/admin/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        current_password: this.passwordForm.current_password,
                        new_password: this.passwordForm.new_password,
                        confirm_password: this.passwordForm.confirm_password
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    this.showChangePasswordModal = false;
                    this.passwordForm = {
                        current_password: '',
                        new_password: '',
                        confirm_password: '',
                        error: '',
                        loading: false
                    };
                } else {
                    this.passwordForm.error = data.message || 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                }
            } catch (error) {
                console.error('Error:', error);
                this.passwordForm.error = 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            } finally {
                this.passwordForm.loading = false;
            }
        },
        
        sidebarOpen: false,
        currentPath: window.location.pathname,
        
        async logout() {
            if (!confirm('ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            try {
                const response = await fetch('/admin/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include'
                });
                
                if (response.ok) {
                    window.location.href = '/admin/login';
                } else {
                    alert('ë¡œê·¸ì•„ì›ƒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ë¡œê·¸ì•„ì›ƒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        },
        
        handleLogout() {
            this.logout();
        },
        
        getCategoryName(category) {
            const categories = {
                'general': 'ì¼ë°˜ ë¬¸ì˜',
                'bug': 'ë²„ê·¸ ì‹ ê³ ',
                'feature': 'ê¸°ëŠ¥ ì œì•ˆ',
                'feedback': 'í”¼ë“œë°±',
                'other': 'ê¸°íƒ€'
            };
            return categories[category] || category;
        },
        
        getStatusName(status) {
            const statuses = {
                'pending': 'ëŒ€ê¸°ì¤‘',
                'replied': 'ë‹µë³€ì™„ë£Œ',
                'closed': 'ì¢…ë£Œ'
            };
            return statuses[status] || status;
        },
        
        formatDate(dateString) {
            // UTC ì‹œê°„ì„ í•œêµ­ ì‹œê°„(KST, UTC+9)ìœ¼ë¡œ ë³€í™˜
            const date = new Date(dateString);
            // í•œêµ­ ì‹œê°„ëŒ€ ì˜µì…˜ ì‚¬ìš©
            return date.toLocaleString('ko-KR', {
                timeZone: 'Asia/Seoul',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true  // ì˜¤ì „/ì˜¤í›„ í‘œì‹œ
            });
        }
    };
}
</script>
{% endblock %}
