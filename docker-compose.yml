services:
  web:
    build:
      context: .
      dockerfile: docker/Dockerfile.prod
    image: multi-chain-tx-lookup:latest
    container_name: chatbot-app
    ports:
      - "8000:8000"
    environment:
      # 블록체인 API 키
      - ETHEREUM_API_KEY=${ETHEREUM_API_KEY}
      - BNB_SMART_CHAIN_API_KEY=${BNB_SMART_CHAIN_API_KEY}
      - POLYGON_API_KEY=${POLYGON_API_KEY}
      - ARBITRUM_API_KEY=${ARBITRUM_API_KEY}
      - OPTIMISM_API_KEY=${OPTIMISM_API_KEY}
      - BLAST_API_KEY=${BLAST_API_KEY}
      - AVALANCHE_API_KEY=${AVALANCHE_API_KEY}
      - MANTLE_API_KEY=${MANTLE_API_KEY}
      - BASE_API_KEY=${BASE_API_KEY}
      - WEMIX_API_KEY=${WEMIX_API_KEY}
      - ENDURANCE_API_KEY=${ENDURANCE_API_KEY}
      - SCROLL_API_KEY=${SCROLL_API_KEY}
      - LINEA_API_KEY=${LINEA_API_KEY}
      - WORLDCHAIN_API_KEY=${WORLDCHAIN_API_KEY}
      - KAIA_BEARER_TOKEN=${KAIA_BEARER_TOKEN}
      - CRONOS_API_KEY=${CRONOS_API_KEY}
      - SOPHSCAN_API_KEY=${SOPHSCAN_API_KEY}
      # MongoDB 설정
      - MONGODB_URI=${MONGODB_URI}
      - MONGODB_DATABASE=${MONGODB_DATABASE:-chatbot_db}
      # OpenAI 설정
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
      - OPENAI_TEMPERATURE=${OPENAI_TEMPERATURE:-0.7}
      - OPENAI_EMBEDDING_MODEL=${OPENAI_EMBEDDING_MODEL:-text-embedding-3-small}
      # LLM 모델별 설정 (선택사항, 기본값은 OPENAI_MODEL 사용)
      - PLANNER_MODEL=${PLANNER_MODEL}
      - PLANNER_TEMPERATURE=${PLANNER_TEMPERATURE:-0.3}
      - WRITER_MODEL=${WRITER_MODEL}
      - WRITER_TEMPERATURE=${WRITER_TEMPERATURE:-0.7}
      - SUMMARIZATION_MODEL=${SUMMARIZATION_MODEL}
      - SUMMARIZATION_TEMPERATURE=${SUMMARIZATION_TEMPERATURE:-0.3}
      - COMPRESSION_MODEL=${COMPRESSION_MODEL}
      - COMPRESSION_TEMPERATURE=${COMPRESSION_TEMPERATURE:-0.2}
      # Router & Grader 모델 설정
      - ROUTER_MODEL=${ROUTER_MODEL}
      - GRADER_MODEL=${GRADER_MODEL}
      # Google Custom Search API (선택사항)
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - GOOGLE_CX=${GOOGLE_CX}
      # 검색 API 설정 (다중 API 지원)
      - SERPER_API_KEY=${SERPER_API_KEY}
      - TAVILY_API_KEY=${TAVILY_API_KEY}
      - BING_SEARCH_API_KEY=${BING_SEARCH_API_KEY}
      - SEARCH_API_PRIORITY=${SEARCH_API_PRIORITY:-google,serper,tavily,bing,duckduckgo}
      - SEARCH_API=${SEARCH_API:-google}
      # 검색 설정
      - MAX_SEARCH_RESULTS=${MAX_SEARCH_RESULTS:-20}
      - MAX_SEARCH_QUERIES=${MAX_SEARCH_QUERIES:-7}
      - MAX_RESULTS_PER_QUERY=${MAX_RESULTS_PER_QUERY:-8}
      # 벡터 DB 설정
      - SIMILARITY_THRESHOLD=${SIMILARITY_THRESHOLD:-0.7}
      - VECTOR_SEARCH_LIMIT=${VECTOR_SEARCH_LIMIT:-3}
      # 검색 결과 처리 설정
      - ENABLE_SUMMARIZATION=${ENABLE_SUMMARIZATION:-true}
      - SUMMARIZATION_THRESHOLD=${SUMMARIZATION_THRESHOLD:-10}
      - ENABLE_COMPRESSION=${ENABLE_COMPRESSION:-true}
      - COMPRESSION_THRESHOLD=${COMPRESSION_THRESHOLD:-15}
      - MAX_SNIPPET_LENGTH=${MAX_SNIPPET_LENGTH:-3000}
      # 로깅 설정
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      # SSL 설정 (선택사항)
      - SSL_KEY_PATH=${SSL_KEY_PATH}
      - SSL_CERT_PATH=${SSL_CERT_PATH}
      # 기타
      - PYTHONUNBUFFERED=1
      - PYTHONIOENCODING=utf-8
      # 트랜잭션 조회 API 설정 (선택사항)
      - USE_TRANSACTION_API=${USE_TRANSACTION_API:-false}
      - TRANSACTION_API_URL=${TRANSACTION_API_URL:-http://localhost:8000}
    env_file:
      - .env
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
    networks:
      - app-network

  wordpress:
    image: wordpress:latest
    environment:
      - WORDPRESS_DB_HOST=db
      - WORDPRESS_DB_USER=wordpress
      - WORDPRESS_DB_PASSWORD=wordpress_password
      - WORDPRESS_DB_NAME=wordpress
      - WORDPRESS_CONFIG_EXTRA=
        define('WP_HOME','https://txid.shop/faq');
        define('WP_SITEURL','https://txid.shop/faq');
    volumes:
      - wordpress_data:/var/www/html
    depends_on:
      - db
    networks:
      - app-network

  db:
    image: mysql:5.7
    environment:
      - MYSQL_DATABASE=wordpress
      - MYSQL_USER=wordpress
      - MYSQL_PASSWORD=wordpress_password
      - MYSQL_ROOT_PASSWORD=root_password
    volumes:
      - db_data:/var/lib/mysql
    networks:
      - app-network

  nginx:
    image: nginx:latest
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./wordpress/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - nginx_logs:/var/log/nginx
      - nginx_html:/var/www/html
    depends_on:
      - web
      - wordpress
    restart: unless-stopped
    networks:
      - app-network

  certbot:
    image: certbot/certbot:latest
    volumes:
      - /etc/letsencrypt:/etc/letsencrypt
      - certbot_data:/var/lib/letsencrypt
      - nginx_html:/var/www/html
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew --webroot --webroot-path=/var/www/html --post-hook \"nginx -s reload\" --no-random-sleep-on-renew --quiet || true; sleep 12h & wait $${!}; done;'"
    depends_on:
      - nginx
    restart: unless-stopped
    networks:
      - app-network

volumes:
  wordpress_data:
  db_data:
  nginx_logs:
  certbot_data:
  nginx_html:

networks:
  app-network:
    driver: bridge 